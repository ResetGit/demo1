<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <title>权限表</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <script src="layui/layui.js" charset="utf-8"></script>
    <script src="js/jquery.js"></script>
</head>
<body>
<table class="layui-hide" id = "menu" lay-filter="menu"></table>

<!--添加权限-->
<div style="display: none;" id="saveOrUpdateDiv">
    <form class="layui-form layui-form-pane" lay-filter="dataFrm" id="dataFrm">

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>权限名称
            </label>
            <div class="layui-input-block">
                <input type="text" name="name" id="name" autocomplete="off" placeholder="请输入权限名称"
                       class="layui-input" lay-verify="required" maxlength="24">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>权限路径
            </label>
            <div class="layui-input-block">
                <input type="text" name="url" id="url" value="/" autocomplete="off" placeholder="请输入权限路径"
                       class="layui-input" lay-verify="required"  maxlength="20">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>排序
            </label>
            <div class="layui-input-block">
                <input type="text" name="sort" id="sort"  autocomplete="off" placeholder="请输入排序"
                       class="layui-input" lay-verify="required"  maxlength="20">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">所属权限</label>
            <div class="layui-input-block">
                <div class="layui-form-select downpanel">
                    <div class="layui-select-title">
                        <input id="chooseName" type="text" placeholder="请选择所属权限" value="默认权限" class="layui-input" lay-verify="required">
                        <input type="hidden" id="chooseID" value="0">
                        <i class="layui-edge"></i>
                    </div>
                    <dl class="layui-anim layui-anim-upbit">
                        <dd>
                            <ul id="test1" class="demo-tree demo-tree-box"></ul>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>




        <div class="layui-form-item" style="text-align: center">
            <button type="button" class="layui-btn layui-btn-normal layui-btn-sm layui-icon layui-icon-release" lay-submit="" lay-filter="device_add">保存</button>
            <button type="reset" class="layui-btn layui-btn-warm layui-btn-sm layui-icon layui-icon-refresh">重置</button>
        </div>
    </form>
</div>


<!--编辑权限-->
<div style="display: none;" id="saveOrUpdateDivEdit">
    <form class="layui-form layui-form-pane" lay-filter="dataFrmEdit" id="dataFrmEdit">

        <div class="layui-form-item" style="display: none;">
            <label class="layui-form-label">
                <span class='x-red'>*</span>ID
            </label>
            <div class="layui-input-block">
                <input type="text" name="id" id="id" autocomplete="off" placeholder="请输入ID"
                       class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>权限名称
            </label>
            <div class="layui-input-block">
                <input type="text" name="nameEdit" id="nameEdit" autocomplete="off" placeholder="请输入权限名称"
                       class="layui-input" lay-verify="required" maxlength="24">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>权限路径
            </label>
            <div class="layui-input-block">
                <input type="text" name="urlEdit" id="urlEdit" value="/" autocomplete="off" placeholder="请输入权限路径"
                       class="layui-input" lay-verify="required"  maxlength="20">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class='x-red'>*</span>排序
            </label>
            <div class="layui-input-block">
                <input type="text" name="sortEdit" id="sortEdit"  autocomplete="off" placeholder="请输入排序"
                       class="layui-input" lay-verify="required"  maxlength="20">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">所属权限</label>
            <div class="layui-input-block">
                <div class="layui-form-select downpanel">
                    <div class="layui-select-title">
                        <input id="chooseNameEdit" type="text" placeholder="请选择所属权限" value="默认权限" class="layui-input" lay-verify="required">
                        <input type="hidden" id="chooseIDEdit" value="0">
                        <i class="layui-edge"></i>
                    </div>
                    <dl class="layui-anim layui-anim-upbit">
                        <dd>
                            <ul id="test1Edit" class="demo-tree demo-tree-box"></ul>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>




        <div class="layui-form-item" style="text-align: center">
            <button type="button" class="layui-btn layui-btn-normal layui-btn-sm layui-icon layui-icon-release" lay-submit="" lay-filter="device_edit">保存</button>
            <button type="reset" class="layui-btn layui-btn-warm layui-btn-sm layui-icon layui-icon-refresh">重置</button>
        </div>
    </form>
</div>


<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-sm" lay-event="add_lay"><i class="layui-icon">&#xe654;</i>新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="refresh_lay"><i class="layui-icon">&#xe666;</i>刷新</button>
    </div>
</script>

<script id="barDemo" type="text/html">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>


<script type="text/javascript">

    layui.config({
        base : 'layui/'
    }).extend({
        treetable : 'treetable-lay/treetable'
    });


    layui.config({
        base: "layui/"
    }).extend({
        treeSelect: "lay/treeSelect/treeSelect"
    });

    layui.use(['treetable', 'table', 'layer','tree','util','treeSelect','form'], function () {
        var tree = layui.tree
            ,layer = layui.layer
            ,util = layui.util
        var form = layui.form;
        var treeSelect= layui.treeSelect;

        var table = layui.table;
        var treetable = layui.treetable;

        //渲染表格
        var renderTable = function(){
            layer.load(2);
            treetable.render({
                id:'#menu',
                treeColIndex: 0,	//树形图标显示在第几列
                treeSpid: '0',		//最上级的父级id
                treeIdName: 'id',	//id字段的名称
                treePidName: 'pid',	//pid字段的名称，父级菜单id
                treeDefaultClose: true,	//是否默认折叠
                treeLinkage: true,		//父级展开时是否自动展开所有子级
                elem: '#menu',	//表格id
                url: 'permission/getListPermissionTree',
                toolbar: '#toolbarDemo',
                page: false,
                cols: [[
                    {field: 'name', title: '权限名称'},
                    {field: 'url' , title: '权限地址'},
                    {field: 'id', title: 'ID'},
                    {field: 'pid' , title: '父级菜单ID'},
                    {field: 'sort' , title: '排序'},
                    {fixed: 'right', title:'操作', toolbar: '#barDemo',align: "center",width:200}
                ]],
                //数据渲染完的回调
                done: function () {
                    //关闭加载
                    layer.closeAll('loading');
                }
            })
        };
        renderTable();


        var treeReload=function(){
            $.ajax({
                url: 'permission/getListPermission',
                type: "post",
                success: function (data) {
                    var formatdata=[];
                    for(var i in data){     // pId为0时表示为根节点
                        if(data[i].pid=='0'){
                            var tempObject={};
                            tempObject.title=data[i].name;
                            tempObject.id=data[i].id;
                            tempObject.children=getChildren(tempObject.id);
                            formatdata.push(tempObject);
                        }
                    }
                    function getChildren(id){    //递归体  即对每条data逐条递归找children
                        var tempArray=[];
                        for(var i in data){
                            if(data[i].pid==id){
                                var tempChild={};
                                tempChild.title=data[i].name;
                                tempChild.id=data[i].id;
                                if(selectChildren(data[i].id,data)){   //若存在子节点，继续递归；否则为叶节点，停止递归
                                    tempChild.children=getChildren(data[i].id);
                                }
                                tempArray.push(tempChild);
                            }
                        }
                        return tempArray;
                    }

                    function selectChildren(id){   // 是否存在子节点
                        for(var i in data){
                            if(data[i].pid==id){
                                return true;
                            }
                        }
                        return false;
                    }

                    //树状编辑
                    tree.render({
                        elem: '#test1Edit' //默认是点击节点可进行收缩
                        ,data:formatdata
                        ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
                        ,click: function(obj) { //点击节点回调
                            var data = obj.data;  //获取当前点击的节点数据
                            $("#chooseNameEdit").val(data.title);
                            $("#chooseIDEdit").val(data.id);
                        }
                    });


                    //树状添加
                    tree.render({
                        elem: '#test1' //默认是点击节点可进行收缩
                        ,data:formatdata
                        ,onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
                        ,click: function(obj) { //点击节点回调
                            var data = obj.data;  //获取当前点击的节点数据
                            $("#chooseName").val(data.title);
                            $("#chooseID").val(data.id);
                        }
                    });
                }

            });
        }
        treeReload();


        //监听头部工具事件
        table.on('toolbar', function(obj){
            var datas = obj.data;
            var checkStatus = table.checkStatus('menu');
            var data = checkStatus.data;
            if(obj.event === 'add_lay'){
                var index = layer.open({
                    title: '添加权限',
                    type: 1,
                    content: $("#saveOrUpdateDiv"),
                    area: ['600px','350px'],
                    success:function (index) {
                        //清空表单
                        $("#dataFrm")[0].reset();
                    }
                });
                // $(window).on("resize", function () {
                //     layer.full(index);
                // });
            }else if(obj.event === "refresh_lay"){
                renderTable();
            }
        })


        //监听行工具事件
        table.on('tool(menu)', function(obj){
            var datas = obj.data;
            var checkStatus = table.checkStatus('menu');
            var data = checkStatus.data;
            if(obj.event === "edit"){
                layer.open({
                    type: 1,
                    title: "修改权限",
                    content: $("#saveOrUpdateDivEdit"),
                    area: ['600px','350px'],
                    success:function () {
                        $("#id").val(datas.id);
                        $("#nameEdit").val(datas.name);
                        $("#urlEdit").val(datas.url);
                        $("#sortEdit").val(datas.sort);
                        $("#chooseIDEdit").val(datas.pid);
                        if (datas.pid==0){
                            $("#chooseNameEdit").val("默认权限");
                        }else if(datas.pid){
                            $.ajax({
                                url: 'permission/getListPermission',
                                type: "post",
                                success: function (data) {
                                    $.each(data,function(index,n){
                                        if(datas.pid==n.id){
                                            $("#chooseNameEdit").val(n.name);
                                        }
                                    });
                                }
                            })

                        }

                    }
                })
            }else if(obj.event === "del"){

                if (datas.pid==0){
                    layer.confirm('确定删除整个权限？', {icon: 2}, function(index){
                        $.ajax({
                            url: 'permission/del',
                            type: "POST",
                            data:{
                                id:datas.id
                            },
                            success: function (res,text,index) {
                                layer.closeAll();　　 //关闭所有层
                                if (text == "success") {
                                    layer.msg("删除成功！", {icon: 1});
                                    renderTable();
                                    treeReload();
                                    parent.location.reload();
                                }
                                if (res.code == "500") {
                                    layer.msg(res.message, {icon: 2});
                                }
                            },
                            error: function (e) {
                                layer.msg("服务器繁忙，请稍后再试"+JSON.stringify(e));
                                return false;
                            }

                        })

                    })
                }else {
                    layer.confirm('确定删除行？', {icon: 2}, function(index){
                        $.ajax({
                            url: 'permission/del',
                            type: "POST",
                            data:{
                                id:datas.id
                            },
                            success: function (res,text,index) {
                                layer.closeAll();　　 //关闭所有层
                                if (text == "success") {
                                    layer.msg("删除成功！", {icon: 1});
                                    renderTable();
                                    treeReload();
                                    parent.location.reload();
                                }
                                if (res.code == "500") {
                                    layer.msg(res.message, {icon: 2});
                                }
                            },
                            error: function (e) {
                                layer.msg("服务器繁忙，请稍后再试"+JSON.stringify(e));
                                return false;
                            }

                        })
                    })
                }

            }
        })

        //监听添加提交
        form.on('submit(device_add)', function (data) {
            var name=$("#name").val();
            var url=$("#url").val();
            var sort=$("#sort").val();
            var chooseID=$("#chooseID").val();
            $.ajax({
                url: 'permission/addPermission',
                type: "POST",
                data:{
                    name:name,
                    url:url,
                    sort:sort,
                    pid:chooseID

                },
                success: function (res,text,index) {
                    layer.closeAll();　　 //关闭所有层
                    if (text == "success") {
                        layer.msg("添加成功！", {icon: 1});
                        renderTable();
                        treeReload();
                        parent.location.reload();
                    }else if (res.code == "500") {
                        layer.msg(res.message, {icon: 2});
                    }
                },
                error: function (e) {
                    layer.msg("服务器繁忙，请稍后再试"+JSON.stringify(e));
                    return false;
                },
            });
            return false;
        });

        //监听修改提交
        form.on('submit(device_edit)', function (data) {
            var id=$("#id").val();
            var name=$("#nameEdit").val();
            var url=$("#urlEdit").val();
            var sort=$("#sortEdit").val();
            var chooseID=$("#chooseIDEdit").val();
            $.ajax({
                url: 'permission/editPermList',
                type: "POST",
                data:{
                    id:id,
                    name:name,
                    url:url,
                    sort:sort,
                    pid:chooseID
                },
                success: function (res,text,index) {
                    layer.closeAll();　　 //关闭所有层
                    if (text == "success") {
                        layer.msg("修改成功！", {icon: 1});
                        renderTable();
                        treeReload();
                        parent.location.reload();
                    }else if (res.code == "500") {
                        layer.msg(res.message, {icon: 2});
                    }
                },
                error: function (e) {
                    layer.msg("服务器繁忙，请稍后再试"+JSON.stringify(e));
                    return false;
                },
            });
            return false;
        });

    });






    //下拉互动
    $(".downpanel").on("click", ".layui-select-title", function (e) {
        $(".downpanel").not($(this).parents(".downpanel")).removeClass("layui-form-selected");
        $(this).parents(".downpanel").toggleClass("layui-form-selected");
        layui.stope(e);
    }).on("click", "dl i", function (e) {
        layui.stope(e);
    });
    $(document).on("click", function (e) {
        $(".downpanel").removeClass("layui-form-selected");
    });
</script>


</body>
</html>